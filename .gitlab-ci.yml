variables:
  # KUBE_INGRESS_BASE_DOMAIN is the application deployment domain and should be set as a variable at the group or project level.
  KUBE_INGRESS_BASE_DOMAIN: nonprod.tower.cdrentertainment.com
  HELM_SCALE_EXTRA_ARGS: --set postgresql.enabled="false" 
  DOCKER_TLS_CERTDIR: ""  # https://gitlab.com/gitlab-org/gitlab-runner/issues/4501
  

stages:
  - eng
  - prod

workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - when: always


eng:
  stage: eng
  image: amazon/aws-cli
  tags:
    - kubernetes
  variables:
    AWS_ACCESS_KEY_ID: $ENG_ACCESS_KEY #still needs to be created
    AWS_SECRET_ACCESS_KEY: $ENG_ACCESS_KEY_SECRET
  script:
    - |
        for f in ./*.json; do
          FN=${f%.*};
          echo $FN;
          TXT=$(cat "${FN}.txt");
          echo $TXT;
          HTML=$(cat "${FN}.html");
          echo $HTML;
          SBJ=$(head -n 1 "${FN}.txt" | tail -c +6 | head -c -5);
          echo $SBJ;
          sed "s/__text__/`echo $TXT`/g" $f;
          sed "s/__html__/`echo $HTML`/g" $f;
          sed "s/__subject__/`echo $SBJ`/g" $f;
        done
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - when: always


prod:
  stage: prod
  allow_failure: false
  image:
    name: amazon/aws-cli
  variables:
    AWS_ACCESS_KEY_ID: $PROD_ACCESS_KEY #still needs to be created
    AWS_SECRET_ACCESS_KEY: $PROD_ACCESS_KEY_SECRET
  script:
    - |
        for f in ./*.json; do
          FN=${f%.*};
          TXT=$(cat "${FN}.txt");
          HTML=$(cat "${FN}.html");
          SBJ=$(head -n 1 "${FN}.txt" | tail -c +6 | head -c -5);
          sed "s/__text__/`echo $TXT`/g" $f;
          sed "s/__html__/`echo $HTML`/g" $f;
        done
    #aws ses create-template --cli-input-json file://tower-account-confirmation.json this goes in the loop eventually
  rules:
    - if: '$BUILD_DISABLED'
      when: never
    - if: $CI_COMMIT_TAG
      when: never
    - when: manual


